# バッチ動画生成機能

複数のJSONファイルを選択して、順番に動画を生成するバッチ処理機能です。

## 機能概要

- 複数のJSONファイルをチェックボックスで選択
- 選択したファイルの内容をプレビュー表示
- 内容確認後、順次動画を生成
- 全体進捗と個別ファイルの進捗をリアルタイム表示
- エラーが発生しても次のファイルに進む
- 生成完了後、`is_generated`フラグを自動更新

## 使い方

### 1. ホームページでモード切り替え

ホームページ（`/`）にアクセスすると、2つのボタンが表示されます：

- **単一動画生成**: 従来の1つずつ生成するモード
- **バッチ動画生成**: 複数ファイルを一括生成するモード（新機能）

### 2. ファイルを選択

1. 「バッチ動画生成」ボタンをクリック
2. 生成可能なJSONファイルの一覧が表示される
3. チェックボックスで生成したいファイルを選択
4. 「すべて選択」ボタンで全ファイルを一括選択可能

### 3. 内容を確認

ファイルを選択すると、自動的に以下の情報が表示されます：

#### 背景画像チェック
- 選択した全ファイルで使用される背景画像の確認
- 不足している背景画像がある場合は警告表示

#### JSONメタ情報
- タイトル
- 推定時間
- テーマ
- キャラクターの気分値
- YouTubeメタデータ（タグ、説明文）

#### 会話プレビュー
- 最初のファイルの会話リストを表示
- セクション区切り付き
- 各セリフの詳細（話者、表情、背景など）
- 折りたたみ/展開可能

#### ファイル詳細（オプション）
- 「ファイル詳細を表示」ボタンで個別ファイル情報を確認
- 各ファイルのセクション構成やセリフ数を展開表示

### 4. バッチ生成を開始

1. 「選択した X 件のファイルの内容を確認しました」チェックボックスをON
2. 「バッチ生成を開始」ボタンをクリック
3. 順次動画生成が開始される

### 5. 進捗を確認

生成中は以下の情報が表示されます：

- **全体進捗**: 完了したファイル数 / 総ファイル数
- **現在処理中のファイル**: ファイル名とステータス
- **個別ファイル進捗**: 現在のファイルの生成進捗（0-100%）
- **完了/失敗リスト**: 各ファイルの状態（✓ 成功、⚠ 失敗）

### 6. 結果を確認

すべてのファイルの処理が完了すると：

- 成功件数と失敗件数が表示される
- 失敗したファイルにはエラーメッセージが表示される
- 成功したファイルは`is_generated: true`に自動更新される

## 技術仕様

### 追加されたファイル

#### フロントエンド

1. **`frontend/src/components/video/BatchVideoGenerator.tsx`**
   - バッチ生成のメインUIコンポーネント
   - ファイル選択、進捗表示、結果サマリー
   - 背景画像チェック、メタ情報、会話プレビューの統合表示

2. **`frontend/src/components/video/JsonFilePreview.tsx`**
   - JSONファイルの内容プレビューコンポーネント
   - 展開/折りたたみ可能

3. **`frontend/src/hooks/useBatchVideoGeneration.ts`**
   - バッチ生成のロジックを管理するカスタムフック
   - 順次処理、WebSocket監視、エラーハンドリング

4. **`frontend/src/hooks/useBatchJsonLoader.ts`**
   - バッチモード用のJSONファイル読み込みフック
   - 複数ファイルの背景画像チェック
   - プレビューデータの管理

### 変更されたファイル

1. **`frontend/src/stores/videoStore.ts`**
   - バッチ生成用の状態管理を追加
   - `batchGeneration`オブジェクトと関連アクション

2. **`frontend/src/pages/HomePage.tsx`**
   - 単一/バッチモード切り替え機能を追加
   - `BatchVideoGenerator`コンポーネントを統合
   - バッチモード用のプレビューデータ連携

3. **`frontend/src/components/video/ConversationList.tsx`**
   - `readOnly`プロップを追加（バッチモードでは削除ボタン非表示）

4. **`frontend/src/components/video/ConversationItem.tsx`**
   - `onRemove`をオプショナルに変更（読み取り専用モード対応）

### 処理フロー

```
1. ユーザーがファイルを選択
   ↓
2. 「内容を確認」で詳細をプレビュー
   ↓
3. 確認チェックボックスをON
   ↓
4. 「バッチ生成を開始」をクリック
   ↓
5. 各ファイルに対して順次実行:
   a. JSONファイルを読み込み
   b. 動画生成APIをコール
   c. WebSocketで進捗監視
   d. 完了後、is_generatedフラグを更新
   e. 次のファイルへ
   ↓
6. 全ファイル完了後、結果サマリーを表示
```

### エラーハンドリング

- **個別ファイルのエラー**: 記録して次のファイルに進む
- **ネットワークエラー**: エラーメッセージを表示して次へ
- **タイムアウト**: 10分でタイムアウト（1ファイルあたり）
- **キャンセル**: 現在のファイル完了後に停止（未実装）

## 注意事項

### 並列処理について

現在の実装では**順次処理**のみサポートしています：

- ファイルは1つずつ順番に処理される
- 前のファイルが完了してから次のファイルに進む
- これによりサーバーリソースの過負荷を防ぐ

並列処理が必要な場合は、Celeryワーカー数を増やし、フロントエンドで複数タスクを同時投稿する実装が必要です（Phase 3で検討）。

### 背景画像チェック

- **自動チェック**: ファイル選択時に全ファイルで使用される背景画像を自動チェック
- **警告表示**: 不足している背景画像がある場合は警告を表示
- **生成可能**: 警告が出ても生成は可能ですが、失敗する可能性があります

### 生成済みファイルの扱い

- `is_generated: true`のファイルは一覧に表示されません
- これにより重複生成を防止します
- 再生成したい場合は、JSONファイルを直接編集して`is_generated: false`に変更してください

## トラブルシューティング

### ファイルが表示されない

- `outputs/json/`ディレクトリにJSONファイルがあるか確認
- `is_generated: true`のファイルは表示されない仕様

### 生成が途中で止まる

- ブラウザのコンソールでエラーを確認
- バックエンドのログを確認（`docker compose logs backend`）
- Celeryワーカーが起動しているか確認

### WebSocket接続エラー

- バックエンドが起動しているか確認
- ネットワーク接続を確認
- ブラウザを再読み込み

## 今後の拡張予定（Phase 3）

以下の機能は実装されていません：

- ❌ 並列生成オプション
- ❌ 生成順序のドラッグ&ドロップ変更
- ❌ 生成履歴の保存
- ❌ 失敗したファイルの再試行ボタン

これらは必要に応じて将来実装される可能性があります。
